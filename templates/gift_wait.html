<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Send Gift - Bixy</title>
    {% load static %}
    {% load humanize %}
    <link rel="stylesheet" href="{% static 'reveal.css' %}">
</head>

<body>
    <nav class="navbar">
        <div class="logo-container" onclick="window.location.href='/'" role="link" tabindex="0">
            <!-- <img src="https://cdn-icons-png.flaticon.com/512/906/906334.png" alt="Logo" class="logo-image" /> -->
            <a href="{% url 'all_gifts' %}" class="logo-text">Bixy</a>
        </div>

        <div class="profile-section" id="profileSection">
            {% if request.user.is_authenticated %}
            <img src="{{ request.user.profile_pic.image.url }}" alt="Profile picture" class="profile-pic" />
            {% else %}
            <a href="{% url 'signin' %}" class="btn login">Login</a>
            <a href="{% url 'signup' %}" class="btn signup">Sign Up</a>
            {% endif %}
        </div>
    </nav>


    <main>
        <section>
            <div class="reveal-container">
                <div class="heading">
                    <p>Oops!</p>
                    <h1>Too Early</h1>
                </div>
                <img src="{% static 'gifts/search.gif' %}" alt="Gift image" style="margin: 2rem 0;">
                <h1>Gift Hidden</h1>
                <p class="msg">This gift from {{ gift_transaction.gifter.username }} has not dropped yet and you cannot claim or see it.</p>
                <p class="timer" id="{{ gift_transaction.id }}" data-prefix="Try again" data-seconds="{{ gift_transaction.seconds_until_drop }}" style="margin-bottom: .5rem;">Try again in --:--:--:--</p>

                <a href="{% url 'reveal_gift' gift_transaction.id %}">Try again</a>
                {% if gift_transaction.cost > 0 and not gift_transaction.is_fastest_finger and not gift_transaction.is_due_for_drop and request.user not in gift_transaction.paid_users.all %}
                <a href="{% url 'reveal_early' gift_transaction.id %}" id="earlyButton" style="margin: .5rem 0 1rem 0;">
                    <div class="cost">
                        <p>Claim now for {{ gift_transaction.cost|intcomma }}</p>
                        <img src="{% static 'gifts/dollar.png' %}" alt="Gift image">
                    </div>
                </a>
                {% endif %}
                <a href="{% url 'view_gift_stats' gift_transaction.id %}" style="margin: .5rem 0 1rem 0;">View Stats</a>
                <!-- <a href="{% url 'all_gifts' %}">Browse more gifts</a> -->
            </div>
        </section>

        <div id="coinModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <div class="gift-info">
                    <div class="gift-image">
                        <img src="{% static 'gifts/dollar.gif' %}" alt="Gift image">
                    </div>
                    <h2>Not Enough Coins!</h2>
                    <p style="text-align: center;  color: #444; font-size: .9rem;">You need <strong
                            id="neededCoins"></strong>
                        more coins to reveal this gift early.</p>

                    <div class="coin-card-container">
                        <div class="coin-card">
                            <div class="coin-image">
                                <img src="{% static 'gifts/dollar.png' %}" alt="Gift image">
                            </div>
                            <div class="coin-info">
                                <p style="font-weight: bold; font-size: 1rem;">50 coins</p>
                            </div>

                            <a href="">$10</a>
                        </div>
                        <div class="coin-card">
                            <div class="coin-image">
                                <img src="{% static 'gifts/dollar.png' %}" alt="Gift image">
                            </div>
                            <div class="coin-info">
                                <p style="font-weight: bold; font-size: 1rem;">50 coins</p>
                            </div>

                            <a href="">$10</a>
                        </div>
                        <div class="coin-card">
                            <div class="coin-image">
                                <img src="{% static 'gifts/dollar.png' %}" alt="Gift image">
                            </div>
                            <div class="coin-info">
                                <p style="font-weight: bold; font-size: 1rem;">50 coins</p>
                            </div>

                            <a href="">$10</a>
                        </div>
                        <div class="coin-card">
                            <div class="coin-image">
                                <img src="{% static 'gifts/dollar.png' %}" alt="Gift image">
                            </div>
                            <div class="coin-info">
                                <p style="font-weight: bold; font-size: 1rem;">50 coins</p>
                            </div>

                            <a href="">$10</a>
                        </div>
                        <div class="coin-card">
                            <div class="coin-image">
                                <img src="{% static 'gifts/dollar.png' %}" alt="Gift image">
                            </div>
                            <div class="coin-info">
                                <p style="font-weight: bold; font-size: 1rem;">50 coins</p>
                            </div>

                            <a href="">$10</a>
                        </div>
                        <div class="coin-card">
                            <div class="coin-image">
                                <img src="{% static 'gifts/dollar.png' %}" alt="Gift image">
                            </div>
                            <div class="coin-info">
                                <p style="font-weight: bold; font-size: 1rem;">50 coins</p>
                            </div>

                            <a href="">$10</a>
                        </div>

                    </div>
                </div>
                <!-- <button onclick="document.getElementById('coinModal').style.display='none'">
                    Okay
                </button> -->
            </div>
        </div>

        <canvas id="sparkleCanvas"></canvas>
    </main>

    <script>
        const canvas = document.getElementById("sparkleCanvas");
        const ctx = canvas.getContext("2d");

        // Handle high DPI screens correctly
        function resizeCanvas() {
            const dpr = window.devicePixelRatio || 1;
            canvas.width = window.innerWidth * dpr;
            canvas.height = window.innerHeight * dpr;
            canvas.style.width = window.innerWidth + "px";
            canvas.style.height = window.innerHeight + "px";
            ctx.setTransform(1, 0, 0, 1, 0, 0); // reset transform
            ctx.scale(dpr, dpr); // scale so drawings stay consistent
        }

        resizeCanvas();
        window.addEventListener("resize", resizeCanvas);

        let stars = [];

        function createStar() {
            return {
                x: Math.random() * window.innerWidth,
                y: window.innerHeight + 10,
                size: Math.random() * 8 + 5,
                speed: Math.random() * 2 + 1,
                opacity: Math.random() * 0.8 + 0.2
            };
        }

        function drawStar(star) {
            const spikes = 4;
            const outerRadius = star.size;
            const innerRadius = star.size / 2;

            ctx.save();
            ctx.beginPath();
            ctx.translate(star.x, star.y);
            ctx.moveTo(0, 0 - outerRadius);

            for (let i = 0; i < spikes; i++) {
                ctx.rotate(Math.PI / spikes);
                ctx.lineTo(0, 0 - innerRadius);
                ctx.rotate(Math.PI / spikes);
                ctx.lineTo(0, 0 - outerRadius);
            }

            ctx.closePath();
            ctx.fillStyle = `rgba(102, 126, 234, ${star.opacity})`;
            ctx.fill();
            ctx.restore();
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            stars.forEach((star, i) => {
                star.y -= star.speed;
                if (star.y < -10) stars[i] = createStar();
                drawStar(star);
            });
            requestAnimationFrame(animate);
        }

        for (let i = 0; i < 40; i++) stars.push(createStar());
        animate();

    </script>

    <script>
        function startCountdown(elementId) {
            const el = document.getElementById(elementId);
            let seconds = parseInt(el.dataset.seconds);
            let prefix = el.dataset.prefix;

            function update() {
                if (seconds < 0) return;

                let d = Math.floor(seconds / (24 * 3600));
                let h = Math.floor((seconds % (24 * 3600)) / 3600);
                let m = Math.floor((seconds % 3600) / 60);
                let s = seconds % 60;

                el.innerText = `${prefix} in ${d}d ${h}h ${m}m ${s}s`;

                seconds--;
                setTimeout(update, 1000);
            }

            update();
        }

        const timers = document.getElementsByClassName('timer');
        for (timer of timers) {
            startCountdown(`${timer.id}`);
        }
    </script>
    
    <script>
        let cost = "{{ gift_transaction.cost }}";

        // Example: Youâ€™d get these values from Django context
        const userCoins = parseInt("{{ request.user.coins }}");  

        document.getElementById("earlyButton").addEventListener("click", function(e) {
        const giftCost = cost;
        if (userCoins < giftCost) {
            e.preventDefault(); // stop form submit
            const needed = giftCost - userCoins;
            console.log(needed);
            document.getElementById("neededCoins").textContent = needed.toLocaleString();
            document.getElementById("coinModal").style.display = "flex"; // show modal
        }
        });

        // Close modal when (X) clicked
        document.querySelector(".close").onclick = function() {
        document.getElementById("coinModal").style.display = "none";
        };

        // Optional: close when clicking outside modal-content
        // window.onclick = function(event) {
        //   if (event.target == document.getElementById("coinModal")) {
        //     document.getElementById("coinModal").style.display = "none";
        //   }
        // };
    </script>

</body>

</html>