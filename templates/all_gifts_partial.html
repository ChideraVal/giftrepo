{% extends 'base.html' %}

{% load static %}
{% load humanize %}
{% load timefilters %}

{% block title %}
<title>New Gifts - Bixy</title>
<link rel="stylesheet" href="{% static 'css/all_gifts.css' %}">
{% endblock %}


{% block body %}
<!-- Banner -->
<!-- <section class="bixy-banner">
    <img src="smiling.png" alt="Referral Logo"
        class="banner-logo">
    <h1 class="banner-heading">Welcome to Bixy Season 1</h1>
    <p class="banner-subtext">Join the fun! Send and claim gifts on Bixy.</p>
    <form class="banner-form" action="{% url 'send_gift' %}" method="get">
        <button type="submit">Join the Fun</button>
    </form>
    <p class="banner-disclaimer">Season ending in 6 days.</p>
</section> -->

<!-- <div class="heading">
    <h1>New Gifts!</h1>
    <p>Active gifts you haven't claimed.</p>
</div> -->

{% if gift_transactions|length > 0 %}
<div class="container">
  <div class="inner" id="scrollArea">

    {% for gift_transaction in gift_transactions %}
    <div class="slide normal" style="background: {% cycle 'linear-gradient(135deg, #7f53d2, black)' 'linear-gradient(135deg, mediumspringgreen, black)' 'linear-gradient(135deg, #f1306d, black)' 'linear-gradient(135deg, midnightblue, black)' 'linear-gradient(135deg, mediumaquamarine, black)' %};">
      {% if gift_transaction.is_visible %}
      <img src="{{ gift_transaction.gift.image.url }}" alt="Gift image">
      {% else %}
      <img src="{% static 'images/search.png' %}" alt="Gift image">
      {% endif %}

      {% if gift_transaction.is_visible %}
      <div class="title">{{ gift_transaction.quantity|intcomma }}x {{ gift_transaction.gift.name }}</div>
      {% else %}
      <div class="title">Hidden Gift</div>
      {% endif %}

      {% if gift_transaction.drop_rate > 0 %}
      {% if gift_transaction.is_due_for_drop %}
      <p class="timer" id="{{ gift_transaction.id }}" data-prefix="Expires"
          data-seconds="{{ gift_transaction.seconds_until_expire }}">Expires in --:--:--:--</p>
      {% else %}
      <p class="timer" id="{{ gift_transaction.id }}" data-prefix="Drops"
          data-seconds="{{ gift_transaction.seconds_until_drop }}">Drops in --:--:--:--</p>
      {% endif %}
      {% else %}
      <p class="timer" id="{{ gift_transaction.id }}" data-prefix="Expires"
          data-seconds="{{ gift_transaction.seconds_until_expire }}">Expires in --:--:--:--</p>
      {% endif %}

      <div class="tags">
        {% if gift_transaction.is_fastest_finger %}
        <p class="tag">Fastest Finger</p>
        {% endif %}

        {% if gift_transaction.early_claim_fee > 0 and not gift_transaction.is_due_for_drop %}
        <p class="tag">Early Claim</p>
        {% endif %}

        {% if request.user in gift_transaction.paid_users.all %}
        <p class="tag">Claimed Early</p>
        {% endif %}
      </div>

      <a class="cta-btn" href="{% url 'reveal_gift' gift_transaction.id %}">
        <div class="cost wh">
            <p>{{ gift_transaction.claim_fee|intcomma }}</p>
            <img src="{% static 'images/key.png' %}" alt="Gift image">
        </div>
      </a>
    </div>
    {% endfor %}

  </div>
</div>
{% else %}
<div class="empty">
    <img src="{% static 'images/empty-box.png' %}" alt="No content image">
    <h1>Feels Empty Here.</h1>
    <a href="{% url 'all_gifts' %}">Refresh</a>
</div>
{% endif %}

{% endblock %}

{% block other %}
<a href="{% url 'send_gift' %}" class="send">
    <img src="{% static 'images/giftbox (1).png' %}" alt="Send gift image">
    <p>Send Gift</p>
</a>
{% endblock %}

{% block scripts %}
<script src="{% static 'scripts/timer.js' %}"></script>

<script>
  document.body.classList.add('scroll');
  document.head.classList.add('scroll');


  const scrollArea = document.getElementById("scrollArea");
  const slides = document.querySelectorAll(".slide");
  
  let currentIndex = 0;
  let adLock = false;
  let isScrolling = false; // NEW FLAG: Prevents double skipping

  function goToSlide(index) {
    // Prevent going out of bounds
    if (index < 0 || index >= slides.length) return;
    
    currentIndex = index;
    
    // 1. Set the cooldown flag immediately
    isScrolling = true;

    const slideHeight = window.innerHeight; // Calculate height dynamically (fix for resize issues)
    
    scrollArea.scrollTo({
      top: index * slideHeight,
      behavior: "smooth"
    });

    const slide = slides[index];

    if (slide.dataset.ad === "true") {
      lockAd(slide);
    }

    // 2. Remove the cooldown flag after the scroll animation finishes (approx 800ms)
    setTimeout(() => {
      isScrolling = false;
    }, 100);
  }

  // WHEEL SCROLL
  scrollArea.addEventListener("wheel", (e) => {
    e.preventDefault();
    
    // CHECK BOTH: If Ad is locked OR if we are currently animating a scroll
    if (adLock || isScrolling) return;

    const dir = e.deltaY > 0 ? 1 : -1;
    const next = currentIndex + dir;
    
    goToSlide(next);
  }, { passive: false });

  // TOUCH
  let startY = 0;
  scrollArea.addEventListener("touchstart", e => startY = e.touches[0].clientY);
  
  scrollArea.addEventListener("touchend", e => {
    // CHECK BOTH HERE TOO
    if (adLock || isScrolling) return;

    const diff = e.changedTouches[0].clientY - startY;
    if (Math.abs(diff) < 50) return; // Sensitivity threshold

    const dir = diff < 0 ? 1 : -1; // Up swipe = next slide
    const next = currentIndex + dir;
    
    goToSlide(next);
  });

  // 3. Keyboard (Arrow Keys & Space)
  window.addEventListener("keydown", (e) => {
    // If locked or scrolling, ignore keys
    if (adLock || isScrolling) return;

    if (e.key === "ArrowDown" || e.key === "ArrowRight" || e.key === " ") {
      e.preventDefault(); // Stop default page scroll
      goToSlide(currentIndex + 1);
    } else if (e.key === "ArrowUp" || e.key === "ArrowLeft") {
      e.preventDefault();
      goToSlide(currentIndex - 1);
    }
  });

  function lockAd(slide) {
    adLock = true;
    scrollArea.classList.add("locked");

    const barContainer = slide.querySelector(".progress-container");
    const bar = slide.querySelector(".progress-bar");

    barContainer.style.opacity = 1;
    bar.style.width = "0%";

    let progress = 0;
    const duration = 5;
    const interval = 100;
    const step = 100 / (duration * 1000 / interval);

    const timer = setInterval(() => {
      progress += step;
      bar.style.width = progress + "%";

      if (progress >= 100) {
        clearInterval(timer);
        barContainer.style.opacity = 0;
        scrollArea.classList.remove("locked");
        adLock = false;
      }
    }, interval);
  }

  // Reset scroll on reload
  if ('scrollRestoration' in history) {
    history.scrollRestoration = 'manual';
  }
  window.scrollTo(0, 0);
  scrollArea.scrollTo(0, 0);
</script>
{% endblock %}