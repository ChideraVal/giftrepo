<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% load static %}
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="{% static 'css/reveal.css' %}" data-css="reveal">
    <link rel="stylesheet" href="{% static 'css/main.css' %}" data-css="main">
    <link rel="stylesheet" href="{% static 'css/all_gifts.css' %}" data-css="all_gifts">

    <title>Loading... - Bixy</title>
</head>

<body>
    <nav class="navbar">
        <div class="logo-container" role="link" tabindex="0">
            <!-- <img src="https://cdn-icons-png.flaticon.com/512/906/906334.png" alt="Logo" class="logo-image" /> -->
            <a href="{% url 'all_gifts' %}" class="logo-text">Bixy</a>
        </div>

        <div class="profile-section" id="profileSection">
            <a href="{% url 'buy_coins' %}" style="text-decoration: none; color: black;">
                <div class="cost">
                    <p>-</p>
                    <img src="{% static 'images/dollar.png' %}" alt="Gift image">
                </div>
            </a>
            <a href="{% url 'buy_coins' %}" style="text-decoration: none; color: black;">
                <div class="cost">
                    <p>-</p>
                    <img src="{% static 'images/key.png' %}" alt="Gift image">
                </div>
            </a>
            <a href="{% url 'profile' %}">
                <img src="{% static 'images/user.png' %}" alt="Profile picture" class="profile-pic" />
            </a>
        </div>
    </nav>

    <main>
        <section>
            <div class="empty" style="margin-top: 200px;">
                <h1 class="state"">Loading...</h1>
            </div>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            function reexecuteScripts(container) {
                const scripts = container.querySelectorAll("script");
                console.log(scripts);
                scripts.forEach(oldScript => {
                    const newScript = document.createElement("script");

                    // copy attributes
                    [...oldScript.attributes].forEach(attr => {
                        newScript.setAttribute(attr.name, attr.value);
                    });

                    // inline scripts
                    if (oldScript.textContent) {
                        newScript.textContent = oldScript.textContent;
                    }

                    oldScript.replaceWith(newScript);
                    console.log(newScript)
                });
            }

            // async function updatePageContent(urlOfPageB) {
            // try {
            // // 1. Fetch Page B's HTML
            // const response = await fetch(urlOfPageB);
            // const htmlText = await response.text();

            // // 2. Parse the fetched HTML
            // const parser = new DOMParser();
            // const docB = parser.parseFromString(htmlText, 'text/html');

            // const headB = docB.head;
            // const bodyB = docB.body;
            // const headA = document.head;

            // // 3. Identify and Collect New Stylesheets
            // const styleLinksB = headB.querySelectorAll('link[rel="stylesheet"]');
            // const loadPromises = [];

            // // 4. Update Page A's Head and Prepare Load Promises
            // styleLinksB.forEach(linkB => {
            // // Check if the stylesheet is already in Page A's head
            // const isAlreadyLoaded = headA.querySelector(`link[href="${linkB.href}"]`);

            // if (!isAlreadyLoaded) {
            // // Create a clone to move it from the parsed document (docB) to the current document
            (document.head)
            // const newLink = linkB.cloneNode();

            // // Append the new link to the current document's head
            // headA.appendChild(newLink);

            // // Create a promise that resolves when the stylesheet loads or errors
            // const loadPromise = new Promise((resolve, reject) => {
            // // Set a timeout as a safety net, in case load/error never fires (less common now)
            // const timeout = setTimeout(() => {
            // console.warn(`Stylesheet ${newLink.href} timed out.`);
            // resolve(newLink.href); // Resolve even on timeout to not block the whole page
            // }, 5000); // 5 seconds timeout

            // // Resolve on success
            // newLink.onload = () => {
            // clearTimeout(timeout);
            // console.log(`Stylesheet ${newLink.href} loaded.`);
            // resolve(newLink.href);
            // };

            // // Resolve on error (to allow the body update to proceed)
            // newLink.onerror = () => {
            // clearTimeout(timeout);
            // console.error(`Error loading stylesheet: ${newLink.href}`);
            // resolve(newLink.href); // Resolve here to not block the body update
            // };
            // });

            // loadPromises.push(loadPromise);
            // }
            // });

            // // 5. WAIT for all new styles to load
            // console.log(`Waiting for ${loadPromises.length} new stylesheets to load...`);
            // await Promise.all(loadPromises);

            // // 6. NOW update the body content
            // document.body.innerHTML = bodyB.innerHTML;
            // console.log("Body content updated successfully with loaded styles.");

            // } catch (error) {
            // console.error('Failed to update page content:', error);
            // }
            // }

            // // Example usage:
            // // updatePageContent('page_b.html');

            // let url = window.location.pathname;
            // updatePageContent(url);


            console.log('FETCHING', window.location.pathname)
            let url = window.location.pathname;
            if (url !== '/loading/') {
                fetch(url, {redirect: "follow"})
                    .then(res => {
                        if (res.redirected) {
                            let next = `/signin/?next=${url}`;
                            // window.open(next, "_parent");
                            window.location.href = next;
                            return Promise.reject('Redirected to login.');
                        } else {
                            return res.text();
                        }
                    })
                    .then(html => {
                        // console.log(html)
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const newHead = doc.head.innerHTML;
                        const newBody = doc.body.innerHTML;
                        // console.log(newBody)

                        // Remove unwanted CSS
                        console.log("URL PATHNAME:", url);
                        let neededCss = 'all_gifts';

                        if (url === '/') {
                            neededCss = 'main';
                        } else if (/^\/gifts\/\d+\/reveal\/?$/.test(url)) {
                            neededCss = 'reveal'
                        }

                        document.querySelectorAll("link[rel='stylesheet']").forEach(link => {
                            if (link.dataset.css !== neededCss) {
                                link.remove();
                            }
                        })

                        // document.head.innerHTML = newHead;
                        document.body.innerHTML = newBody;
                        reexecuteScripts(document.body);
                    })
                    .catch((err) => {
                        document.querySelector('.empty').innerHTML = `
                    <h1>Something went wrong</h1>
                    <a href="">Refresh</a>
                    `;
                    })
            }
        })

    </script>
</body>

</html>