<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch Ad - Bixy</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/ads.css' %}">
</head>

<body>

    <div id="progress"></div>

    <div class="ad-container">
        <img id="adImage" class="ad-image" src="" />
        <h2 id="ad-title"></h2>
        <p id="ad-description"></p>
        <a id="ad-cta" target="_blank"></a>
    </div>

    <div class="controls">
        <div id="timer"></div>
        <button id="nextBtn">Continue</button>
    </div>

    <script>
        // const numberOfAds = 4;
        const duration = 5; // seconds per ad
        let currentIndex = 0;
        let viewedAds = [];
        let ads = [];

        const adContainer = document.querySelector(".ad-container");
        const adImage = document.getElementById("adImage");
        const progress = document.getElementById("progress");
        const timerEl = document.getElementById("timer");
        const nextBtn = document.getElementById("nextBtn");

        nextBtn.style.visibility = "hidden";

        // ----------- PRELOAD ADS FUNCTION -----------
        function preloadAds(adUrls) {
            const promises = adUrls.map(url => new Promise((resolve, reject) => {
                const img = new Image();
                img.src = url;
                img.onload = () => resolve(url);
                img.onerror = () => reject(url);
            }));
            return Promise.all(promises);
        }

        // --- Send a single ad immediately when fully viewed ---
        function sendSingleViewedAd(adId) {
            console.log(adId)
            fetch('/reportadview/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ad_id: adId })
            }).catch(() => alert('Failed to send viewed ad: ' + adId));
        }

        // --- Fallback for page close / reload ---
        window.addEventListener('beforeunload', () => {
            viewedAds.forEach(adId => {
                console.log('SENDING BEACON...')
                navigator.sendBeacon('/reportadview/', JSON.stringify({ 'ad_id': adId }));
            });
        });

        // --- Load ad with timer ---
        function loadAd(index) {
            adImage.src = ads[index].image;
            document.getElementById("ad-title").innerText = ads[index].title;
            document.getElementById("ad-description").innerText = ads[index].description;

            const cta = document.getElementById("ad-cta");
            cta.innerText = ads[index].cta_text;
            cta.href = ads[index].cta_url;

            nextBtn.classList.remove("enabled");
            timerEl.innerText = `Loading ad...`;

            progress.style.transition = "none";
            progress.style.width = "0%";
            progress.offsetWidth;

            setTimeout(() => {
                progress.style.transition = "width " + duration + "s linear";
                progress.style.width = "100%";
            }, 100);

            let timeLeft = duration;
            timerEl.innerText = `Viewing ad... ${timeLeft}s`;

            const countdown = setInterval(() => {
                timeLeft--;
                if (timeLeft > 0) {
                    timerEl.innerText = `Viewing ad... ${timeLeft}s`;
                } else {
                    clearInterval(countdown);
                    if (index == ads.length - 1) {
                        // This is the last Ad
                        timerEl.innerText = `All ads viewed!`;
                    } else {
                        timerEl.innerText = `Click "Continue" to Proceed.`;
                    }
                    nextBtn.style.visibility = "visible";
                    nextBtn.classList.add("enabled");

                    if (!viewedAds.includes(ads[index])) {
                        viewedAds.push(ads[index]);
                        sendSingleViewedAd(ads[index].id); // send immediately
                    }
                }
            }, 1000);
        }

        // --- Handle next button ---
        nextBtn.onclick = () => {
            nextBtn.style.visibility = "hidden";
            if (!nextBtn.classList.contains("enabled")) return;

            if (currentIndex < ads.length - 1) {
                currentIndex++;
                loadAd(currentIndex);
                if (currentIndex == ads.length - 1) {
                    // This is the last Ad
                    nextBtn.innerText = "Get Key";
                }
            } else {
                timerEl.innerText = "All ads viewed!";
                progress.style.width = "100%";
                nextBtn.innerText = "Claim Reward";
                nextBtn.classList.remove("enabled");

                // Reward player
                alert(`Congratulations! You viewed ${viewedAds.length} ads and earned your reward.`);
            }
        };

        // ----------- START AFTER PRELOADING ADS -----------
        fetch("/ads/")
            .then(response => response.json())
            .then(data => {
                ads = data.ads;

                if (ads.length === 0) {
                    // alert("No ads available right now.");
                    adContainer.innerHTML = "<p>No ads available right now.</p>"
                    return;
                }

                // Extract image URLs for preloading
                const adImages = ads.map(a => a.image);

                preloadAds(adImages)
                    .then(() => loadAd(currentIndex))
                    .catch(() => {
                        // alert("Some ads failed to load.");
                        adContainer.innerHTML = "<p>Some ads failed to load.</p>"
                        loadAd(currentIndex);
                    });
            })
            .catch((err) => {
                alert(err);
            });


    </script>

</body>

</html>