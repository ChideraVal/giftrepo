<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Slides With Clean Ad Lock</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      height: 100%;
      overflow: hidden;
      background: #000;
      font-family: Arial, sans-serif;
    }

    .container {
      height: 100vh;
      overflow: hidden;
    }

    .inner {
      height: 100%;
      /* REMOVED scroll-snap-type because we are using JS to control positions */
      overflow: hidden; 
    }

    /* Added a class to allow manual scrolling only when needed, 
       though your logic mostly handles this via JS events */
    .inner.locked {
      overflow-y: hidden !important;
      pointer-events: none !important; 
    }

    .slide {
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: #fff;
      text-align: center;
      padding: 20px;
      position: relative;
    }

    .slide.normal:nth-child(odd) { background: #111; }
    .slide.normal:nth-child(even) { background: #222; }
    .slide.ad { background: #550000; }

    .ad-label {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #ff0050;
      padding: 6px 12px;
      border-radius: 6px;
    }

    .progress-container {
      position: absolute;
      bottom: 30px;
      left: 5%;
      width: 90%;
      height: 6px;
      background: rgba(255,255,255,0.3);
      border-radius: 10px;
      overflow: hidden;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      background: #ff0050;
      transition: width 0.1s linear;
    }

    .title { font-size: 32px; margin-bottom: 16px; font-weight: bold; }
    .description { font-size: 18px; opacity: 0.9; margin-bottom: 25px; max-width: 90%; }
    .cta-btn { padding: 14px 28px; background: #ff0050; border: none; border-radius: 8px; color: #fff; font-size: 18px; cursor: pointer; }
  </style>
</head>

<body>

<div class="container">
  <div class="inner" id="scrollArea">

    <div class="slide normal">
      <div class="title">Welcome</div>
      <div class="description">Scroll to continue</div>
      <button class="cta-btn">Start</button>
    </div>

    <div class="slide ad" data-ad="true">
      <div class="ad-label">AD</div>
      <div class="title">Sponsored Ad</div>
      <div class="description">Please wait 5 seconds.</div>
      <div class="progress-container">
        <div class="progress-bar"></div>
      </div>
    </div>

    <div class="slide normal">
      <div class="title">Track Progress</div>
      <div class="description">Simple dashboard</div>
      <button class="cta-btn">Learn More</button>
    </div>

    <div class="slide ad" data-ad="true">
      <div class="ad-label">AD</div>
      <div class="title">Brand Promo</div>
      <div class="description">Wait 5 seconds.</div>
      <div class="progress-container">
        <div class="progress-bar"></div>
      </div>
    </div>

    <div class="slide normal">
      <div class="title">Join Us</div>
      <div class="description">Become part of the family</div>
      <button class="cta-btn">Sign Up</button>
    </div>

  </div>
</div>

<script>
  const scrollArea = document.getElementById("scrollArea");
  const slides = document.querySelectorAll(".slide");
  
  let currentIndex = 0;
  let adLock = false;
  let isScrolling = false; // NEW FLAG: Prevents double skipping

  function goToSlide(index) {
    // Prevent going out of bounds
    if (index < 0 || index >= slides.length) return;
    
    currentIndex = index;
    
    // 1. Set the cooldown flag immediately
    isScrolling = true;

    const slideHeight = window.innerHeight; // Calculate height dynamically (fix for resize issues)
    
    scrollArea.scrollTo({
      top: index * slideHeight,
      behavior: "smooth"
    });

    const slide = slides[index];

    if (slide.dataset.ad === "true") {
      lockAd(slide);
    }

    // 2. Remove the cooldown flag after the scroll animation finishes (approx 800ms)
    setTimeout(() => {
      isScrolling = false;
    }, 800);
  }

  // WHEEL SCROLL
  scrollArea.addEventListener("wheel", (e) => {
    e.preventDefault();
    
    // CHECK BOTH: If Ad is locked OR if we are currently animating a scroll
    if (adLock || isScrolling) return;

    const dir = e.deltaY > 0 ? 1 : -1;
    const next = currentIndex + dir;
    
    goToSlide(next);
  }, { passive: false });

  // TOUCH
  let startY = 0;
  scrollArea.addEventListener("touchstart", e => startY = e.touches[0].clientY);
  
  scrollArea.addEventListener("touchend", e => {
    // CHECK BOTH HERE TOO
    if (adLock || isScrolling) return;

    const diff = e.changedTouches[0].clientY - startY;
    if (Math.abs(diff) < 50) return; // Sensitivity threshold

    const dir = diff < 0 ? 1 : -1; // Up swipe = next slide
    const next = currentIndex + dir;
    
    goToSlide(next);
  });

  function lockAd(slide) {
    adLock = true;
    scrollArea.classList.add("locked");

    const barContainer = slide.querySelector(".progress-container");
    const bar = slide.querySelector(".progress-bar");

    barContainer.style.opacity = 1;
    bar.style.width = "0%";

    let progress = 0;
    const duration = 5;
    const interval = 100;
    const step = 100 / (duration * 1000 / interval);

    const timer = setInterval(() => {
      progress += step;
      bar.style.width = progress + "%";

      if (progress >= 100) {
        clearInterval(timer);
        barContainer.style.opacity = 0;
        scrollArea.classList.remove("locked");
        adLock = false;
      }
    }, interval);
  }

  // Reset scroll on reload
  if ('scrollRestoration' in history) {
    history.scrollRestoration = 'manual';
  }
  window.scrollTo(0, 0);
  scrollArea.scrollTo(0, 0);
</script>

</body>
</html>